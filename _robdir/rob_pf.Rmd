---
title: "Análisis de Supervivencia"
author: "Jose Reyes"
date: "23/5/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(stringr)
library(tidyverse)
library(survival)
library(KMsurv)
library(actuar)
library(BGPhazard)
library(rmutil)
library(survminer)
```

#Efecto de la Digoxina en Pacientes con Falla Cardiaca

### Carga de datos
```{r,warning=FALSE}
df <- read_csv("../DIG.csv")

colnames(df) <- tolower(colnames(df))
```

#### Variables de Control 

```{r}
control <- c(
"id","trtmt","age","race","sex","ejf_per","ejfmeth","chestx","bmi","klevel","creat","digdoser","chfdur","rales",  
"elevjvp","pedema","restdys","exertdys","actlimit","s3","pulcong","nsym","heartrte","diabp","sysbp","functcls","chfetiol","prevmi", 
 "angina","diabetes","hyperten","diguse","diuretk","diuret","ksupp","aceinhib","nitrates","hydral","vasod","digdose"
)

df_control <- df[control]
```





#### Datos para Muerte

- 0 si el paciente vive
- 1 si el paciente murió 

Reason
- 1=Worsening Heart Failure
- 2=Other Cardiac
- 3=Other Vascular
- 4=Unknown
- 5=Non cardiac, nonvascular cause



```{r}
df_death <- df[c("id","trtmt","death","deathday","reason")]
df_death$reason[is.na(df$reason)] <- 0
```

##### Exploración inicial de pregunta: ¿Existe algún efecto del uso de la digoxina en la mortalidad?

###### Análisis 1: ¿Qué porcentaje de la gente que tomo el medicamento se murió?
```{r}
df_death %>% 
    group_by(trtmt) %>% 
    summarise(
        total = n(),
        deaths = sum(death)
        ) %>% 
    mutate(
        prop = round(deaths/total, 3),
        trtmt = ifelse(trtmt == 0, "Sin Tratamiento", "Con Tratamiento")
        ) %>% 
    ggplot(
        aes(x = trtmt, y = prop, fill = trtmt)
    ) +
    geom_bar(stat = "identity") +
    scale_y_continuous(limits = c(0, 1)) + 
    ylab("Proporción de muertes") + xlab("") + labs(fill = "") +
    ggtitle("Proporción de muertes diferenciando por tratamiento")
```
Los datos sugieren que no hay una diferencia notoria en la situación final de los pacientes al diferenciar por tratamiento.



###### Análisis 2: ¿Cómo fue cambiando la proporción vivos/muertos de pacientes a lo largo del tiempo diferenciando por tratamiento/no_tratamiento?
```{r}
df_death
```



##### Análisis de regresión

###### Ajuste de modelo base
```{r}
## Copia de datos originales
dfx <- df_death

## Definición de objeto de supervivencia
t <- Surv(dfx$deathday, dfx$death)

## Modelos base con distintas familias
xfitr <- survreg(t ~ trtmt, data = dfx, dist = "weibull")
summary(xfitr)

xfitr <- survreg(t ~ trtmt, data = dfx, dist = "lognormal")
summary(xfitr)

xfitr <- survreg(t ~ trtmt, data = dfx, dist = "loglogistic")
summary(xfitr)
```


###### Ajuste de modelo base
```{r}
## Copia de datos originales
dfx <- df_death

## Definición de objeto de supervivencia
t <- Surv(dfx$deathday, dfx$death)

## Modelos base con distintas familias
xfitr <- coxph(t ~ trtmt, data = dfx, dist = "weibull")
summary(xfitr)

xfitr <- coxph(t ~ trtmt, data = dfx, dist = "lognormal")
summary(xfitr)

xfitr <- coxph(t ~ trtmt, data = dfx, dist = "loglogistic")
summary(xfitr)
```





#### Datos para Hospitalización de Pacientes por falla Cardiaca

- 0 si no fue hospitalizado ni murió por falla cardiaca
- 1 si sí fue hospitalizado o murió por falla cardiaca

```{r}
df_hosp <- df[c("id","trtmt","dwhf","dwhfdays")]
```
#### Estimador Kaplan-Maier

### Muertes
```{r}
ggsurvplot(
    fit = survfit(Surv(deathday, death) ~ trtmt, data = df_death,conf.type = "log-log"),
    xlab = "Días",
    ylab = "Probabilidad de Supervivencia",
    legend.title = "Treatment",
    legend.labs = c("Control",
    "Treatment"),
    conf.int = TRUE,
    pval = TRUE,
    size =.5,
    linetype = "strata",
    times=seq(0,1781+30,120))


ci<-cmprsk::cuminc(
    ftime = df_death$deathday,
    fstatus = df_death$reason,
    group = df_death$trtmt,
    #strata = df_death$trtmt[df_death$death==1],
    rho = 1,
    cencode = 0,
    )
ggcompetingrisks(ci,
                 multiple_panels = TRUE,
                 xlab = "Días",
                  ylab = "Incidencia Acumulada",
                  title = "Muerte por tipo",
                 legend.title = "Evento",
                 conf.int = TRUE,
    pval = TRUE,

                  )

ci$Tests



```

```{r}
ggsurvplot(
    fit = survfit(Surv(dwhfdays, dwhf) ~ trtmt, data = df_hosp,conf.type = "log-log"),
    xlab = "Días",
    ylab = "Probabilidad de Supervivencia",
    legend.title = "Treatment",
    legend.labs = c("Control",
    "Treatment"),
    conf.int = TRUE,
    pval = TRUE,
    size =.5,
    linetype = "strata",
    times=seq(0,1781+30,120))





```





### Notas adicionales (Rob)

###### Pruebas adicionales
```{r}
## Asociación de los tiempos de muerte y la variable "tratamiento"
# xfit <- survfit(t ~ dfx$trtmt)

# t
# xfit$n
# xfit$time
# xfit$n.event

## 
# n <- c(0, cumsum(xfit$n))
# for (l in 1:2){
#   # print((n[l] + 1):n[l + 1])
#   print(paste0("Valor 1 = ", (n[l] + 1), "    Valor 2 = ", n[l + 1]))
#   tj <- xfit$time[(n[2] + 1):n[2 + 1]]
#   sj <- xfit$surv[(n[l] + 1):n[l + 1]]
#   k <- length(tj)
#   sje <- 0.5*sj + 0.5*c(1, sj[-k]) ## Esta es la supervivencia corregida
#   plot(log(tj), log(-log(sje)), main=paste("Tratamiento = ", l))
# }
```
